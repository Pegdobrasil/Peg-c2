<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Pedidos ‚Ä¢ Peg do Brasil</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Tema da PEG (cores/estilo que combinam com a logo) -->
  <link href="{{ url_for('static', filename='index.css') }}" rel="stylesheet" />

  <style>
    /* ---------- Mini KPI no navbar ---------- */
    .kpi-badge{ --bg:#ffffff22; --bd:#ffffff44; --fg:#fff;
      display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .5rem;
      border:1px solid var(--bd); border-radius:999px; color:var(--fg); background:var(--bg);
      font-weight:600; line-height:1; }
    .kpi-dot{ width:.55rem; height:.55rem; border-radius:50%; display:inline-block; }
    .dot-p{ background:#ffcb2b; }
    .dot-s{ background:#69b3ff; }
    .dot-a{ background:#ffd38e; }
    .dot-c{ background:#7bd99a; }
    .btn-refresh{ backdrop-filter:saturate(140%) blur(2px); }

    /* ---------- Mini Dashboard (offcanvas) ---------- */
    .dash-ring{
      --p:0; --size:84px; --track:#eef2f7; --fill:#4f46e5;
      width:var(--size); height:var(--size);
      border-radius:50%; display:grid; place-items:center;
      background:
        radial-gradient(closest-side, #fff 66%, transparent 67% 100%),
        conic-gradient(var(--fill) calc(var(--p)*1%), var(--track) 0);
      box-shadow:0 1px 0 rgba(0,0,0,.06) inset;
    }
    .dash-ring small{ color:#6b7280; font-weight:600; letter-spacing:.2px; }
    .dash-ring b{ font-size:1.15rem; }
    .kpi-tile{
      border:1px solid #eef2f7; border-radius:14px; padding:14px;
      background:#fff; box-shadow: 0 4px 14px rgba(20,52,89,.04);
    }
    .progress.slim{ height:.5rem; border-radius:999px; background:#f1f5f9; }
    .progress.slim .progress-bar{ background:linear-gradient(90deg,#16a34a,#22c55e); }
    .badge-soft{ background:#f1f5f9; color:#334155; }

    .bg-brand{ background:#0d3b66; } /* barra superior */
    .page-head .head-card{ background:#fff; border:1px solid #e9eef6; border-radius:16px; padding:18px; }
    .logo-brand{ filter: drop-shadow(0 0 0 rgba(0,0,0,0)); }
  </style>
</head>
<body class="bg-page">

  {# ---- N√∫meros calculados no servidor para render inicial ---- #}
  {% set n_p = pendentes|length %}
  {% set n_s = separacao|length %}
  {% set n_a = aguardando|length %}
  {% set n_c = coletado|length %}
  {% set total = (n_p + n_s + n_a + n_c) if (n_p + n_s + n_a + n_c) > 0 else 1 %}

  {% set m_s = separacao|selectattr('transportadoraId','equalto',23)|list|length %}
  {% set m_a = aguardando|selectattr('transportadoraId','equalto',23)|list|length %}

  <!-- NAV SUPERIOR (fixa) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-brand shadow-sm sticky-top">
    <div class="container-xxl">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/" title="Painel de Pedidos">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="PEG do Brasil" height="28" class="logo-brand">
        <span class="fw-semibold">Painel de Pedidos</span>
      </a>

      <!-- KPIs compactos no topo -->
      <div class="d-none d-lg-flex align-items-center gap-2 mx-3 flex-wrap">
        <span class="kpi-badge" id="kpi-p">
          <i class="kpi-dot dot-p"></i> P: <span class="val">{{ n_p }}</span>
        </span>
        <span class="kpi-badge" id="kpi-s">
          <i class="kpi-dot dot-s"></i> S: <span class="val">{{ n_s }}</span>
        </span>
        <span class="kpi-badge" id="kpi-a">
          <i class="kpi-dot dot-a"></i> A: <span class="val">{{ n_a }}</span>
        </span>
        <span class="kpi-badge" id="kpi-c">
          <i class="kpi-dot dot-c"></i> C: <span class="val">{{ n_c }}</span>
        </span>
      </div>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div id="topNav" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
          <li class="nav-item"><a class="btn btn-outline-light btn-sm" href="/historico">Hist√≥rico</a></li>
          <li class="nav-item"><a class="btn btn-success btn-sm" href="/estoque">Controle de Estoque</a></li>
	  <li class="nav-item">
 		 <a class="btn btn-warning btn-sm" href="/conferencia-imagem" target="_blank" rel="noopener">
 		   üñºÔ∏è Confer√™ncia de Imagem
 		 </a>
		</li>

          <!-- Bot√µes de a√ß√£o -->
   	   <li class="nav-item">
		  <a class="btn btn-outline-light btn-sm" href="/tarefas">Tarefas</a>
		</li>
          <li class="nav-item d-flex align-items-center">
            <button class="btn btn-outline-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#miniDash" aria-controls="miniDash">
              üìä Dashboard
            </button>
          </li>
          <li class="nav-item"><a class="btn btn-outline-light btn-sm" href="/admin">Administrador</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- MINI DASHBOARD (Offcanvas) -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="miniDash" aria-labelledby="miniDashLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="miniDashLabel">Mini Dashboard ‚Ä¢ Hoje</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body">
      <div class="row g-3">
        <!-- Donuts -->
        <div class="col-6 col-md-3">
          <div class="kpi-tile text-center">
            <div class="dash-ring mx-auto mb-2" id="donut-p" style="--p: {{ (100*n_p/total)|round(0,'floor') }}; --fill:#ffcb2b;"></div>
            <small>Pendentes</small><br><b id="donut-p-val">{{ n_p }}</b>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="kpi-tile text-center">
            <div class="dash-ring mx-auto mb-2" id="donut-s" style="--p: {{ (100*n_s/total)|round(0,'floor') }}; --fill:#69b3ff;"></div>
            <small>Separa√ß√£o</small><br><b id="donut-s-val">{{ n_s }}</b>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="kpi-tile text-center">
            <div class="dash-ring mx-auto mb-2" id="donut-a" style="--p: {{ (100*n_a/total)|round(0,'floor') }}; --fill:#ffd38e;"></div>
            <small>Aguardando</small><br><b id="donut-a-val">{{ n_a }}</b>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="kpi-tile text-center">
            <div class="dash-ring mx-auto mb-2" id="donut-c" style="--p: {{ (100*n_c/total)|round(0,'floor') }}; --fill:#7bd99a;"></div>
            <small>Coletado</small><br><b id="donut-c-val">{{ n_c }}</b>
          </div>
        </div>

        <!-- KPIs Motoboy -->
        <div class="col-12 col-md-6">
          <div class="kpi-tile">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fw-semibold">Motoboy em Separa√ß√£o</span>
              <span class="badge badge-soft"><b id="mb-s-val">{{ m_s }}</b> / <span id="tot-s-val">{{ n_s }}</span></span>
            </div>
            <div class="progress slim">
              <div id="mb-s-bar" class="progress-bar" role="progressbar"
                   style="width: {{ (100*(m_s/(n_s if n_s>0 else 1)))|round(0,'floor') }}%"
                   aria-valuenow="{{ (100*(m_s/(n_s if n_s>0 else 1)))|round(0,'floor') }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <div class="kpi-tile">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fw-semibold">Motoboy Aguardando</span>
              <span class="badge badge-soft"><b id="mb-a-val">{{ m_a }}</b> / <span id="tot-a-val">{{ n_a }}</span></span>
            </div>
            <div class="progress slim">
              <div id="mb-a-bar" class="progress-bar" role="progressbar"
                   style="width: {{ (100*(m_a/(n_a if n_a>0 else 1)))|round(0,'floor') }}%"
                   aria-valuenow="{{ (100*(m_a/(n_a if n_a>0 else 1)))|round(0,'floor') }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        </div>

        <!-- Rodap√© mini dash -->
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted small">√öltima atualiza√ß√£o: <span id="dash-last">agora</span></span>
            <button class="btn btn-sm btn-primary" onclick="refreshSnapshot()">‚ü≥ Atualizar (dif)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- T√çTULO / SUBHEAD -->
  <header class="page-head">
    <div class="container-xxl">
      <div class="head-card shadow-sm">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div>
            <h1 class="h4 mb-1">Painel operacional</h1>
            <p class="mb-0 text-muted">Atualiza√ß√£o em tempo real dos pedidos e movimenta√ß√µes</p>
          </div>
          <div class="d-flex align-items-center gap-2">
            <a class="btn btn-brand" href="#logmanager" title="Importar/Acompanhar entregas">Abrir LogManager</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- √ÅREA PRINCIPAL -->
  <main class="container-xxl py-3" id="listas">
    <!-- √°udio de notifica√ß√£o -->
    <audio id="notif-audio" preload="auto">
      <source src="{{ url_for('static', filename='Notifica√ß√£o.mp3') }}" type="audio/mpeg">
    </audio>

    <!-- Bipagem (scanner) -->
    {% include "partials/form_bipagem.html" %}

    <!-- Mensagens flash -->
    {% include "partials/mensagens.html" %}

    <!-- Tabelas principais -->
    {% include "partials/tabelas.html" %}

    <!-- LogManager ‚Äì acompanhamento e importa√ß√£o -->
    <section id="logmanager" class="mt-4">
      {% include "partials/logmanager_table.html" %}
      {% include "partials/logmanager_modal.html" %}
    </section>

    <!-- Pedidos avulsos -->
    {% include "partials/avulsos.html" %}

    <!-- Rodap√© (links auxiliares) -->
    {% include "partials/footer.html" %}
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  {% include "partials/scripts.html" %}

  <script>
    /* ---------- Atualiza√ß√£o din√¢mica dos contadores e mini dashboard ---------- */
    function getTotalsFromDOM(){
      const q = sel => document.querySelectorAll(sel).length;
      const n_p = q('#tbody-pendentes tr[data-codigo]');
      const n_s = q('#tbody-separacao tr[data-codigo]');
      const n_a = q('#tbody-aguardando tr[data-codigo]');
      const n_c = q('#tbody-coletado tr[data-codigo]');
      const total = Math.max(1, n_p+n_s+n_a+n_c);

      // Motoboy shares (transportadoraId = 23) via badge de transportadora
      const countMoto = (tbodyId) => {
        let n = 0;
        const rows = document.querySelectorAll(`#${tbodyId} tr[data-codigo]`);
        rows.forEach(r=>{
          const badge = r.children[3]?.querySelector('.badge');
          if(!badge) return;
          // heur√≠stica: badge .text-bg-primary √© motoboy (23) nas nossas tabelas
          if (badge.classList.contains('text-bg-primary')) n++;
        });
        return n;
      };
      const m_s = countMoto('tbody-separacao');
      const m_a = countMoto('tbody-aguardando');

      return { n_p,n_s,n_a,n_c,total,m_s,m_a };
    }

    function updateNavbarAndDash(){
      const {n_p,n_s,n_a,n_c,total,m_s,m_a} = getTotalsFromDOM();

      // Badges do topo
      document.querySelector('#kpi-p .val').textContent = n_p;
      document.querySelector('#kpi-s .val').textContent = n_s;
      document.querySelector('#kpi-a .val').textContent = n_a;
      document.querySelector('#kpi-c .val').textContent = n_c;

      // Donuts
      const setDonut = (id, val, perc) => {
        const el = document.getElementById(id);
        const txt = document.getElementById(id+'-val');
        if(el) el.style.setProperty('--p', String(perc));
        if(txt) txt.textContent = val;
      };
      setDonut('donut-p', n_p, Math.floor(100*n_p/total));
      setDonut('donut-s', n_s, Math.floor(100*n_s/total));
      setDonut('donut-a', n_a, Math.floor(100*n_a/total));
      setDonut('donut-c', n_c, Math.floor(100*n_c/total));

      // Motoboy KPIs
      const mbS = Math.floor(100*(m_s/Math.max(1,n_s)));
      const mbA = Math.floor(100*(m_a/Math.max(1,n_a)));
      const elMbS = document.getElementById('mb-s-bar');
      const elMbA = document.getElementById('mb-a-bar');
      const vMbS = document.getElementById('mb-s-val');
      const vMbA = document.getElementById('mb-a-val');
      const tS = document.getElementById('tot-s-val');
      const tA = document.getElementById('tot-a-val');
      if(elMbS){ elMbS.style.width = mbS+'%'; elMbS.setAttribute('aria-valuenow', mbS); }
      if(elMbA){ elMbA.style.width = mbA+'%'; elMbA.setAttribute('aria-valuenow', mbA); }
      if(vMbS) vMbS.textContent = m_s;
      if(vMbA) vMbA.textContent = m_a;
      if(tS) tS.textContent = n_s;
      if(tA) tA.textContent = n_a;
    }

    function setLastUpdated(){
      const el = document.getElementById('dash-last');
      if(!el) return;
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      el.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // Observa mudan√ßas nas tabelas e atualiza os KPIs automaticamente
    const obs = new MutationObserver(()=>{ updateNavbarAndDash(); });
    window.addEventListener('load', ()=>{
      const listas = document.getElementById('listas');
      if(listas) obs.observe(listas, {childList:true, subtree:true});
      updateNavbarAndDash();
      setLastUpdated();
    });

    // Integra com a atualiza√ß√£o por DIF (se existir a fun√ß√£o global refreshSnapshot)
    // Monkey-patch leve para carimbar hor√°rio e atualizar KPIs ap√≥s o refresh
    (function patchRefresh(){
      if(typeof window.refreshSnapshot !== 'function'){
        // tenta novamente ap√≥s os scripts das parciais carregarem
        setTimeout(patchRefresh, 600);
        return;
      }
      const _orig = window.refreshSnapshot;
      window.refreshSnapshot = async function(){
        const r = await _orig.apply(this, arguments);
        updateNavbarAndDash();
        setLastUpdated();
        return r;
      }
    })();
  </script>
</body>
</html>
