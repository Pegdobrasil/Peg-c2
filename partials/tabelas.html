<!-- ===== LEGENDAS DID√ÅTICAS (no topo) ===== -->
<section class="mb-3">
  <div class="legend card border-0 shadow-sm">
    <div class="card-body d-flex flex-wrap align-items-center gap-2">
      <strong class="me-2">Legenda:</strong>
      <span class="chip chip-pendente">5 Pendentes (sem etiqueta)</span>
      <span class="chip chip-separacao">6 Separa√ß√£o</span>
      <span class="chip chip-aguardando">36 Aguardando Coleta</span>
      <span class="chip chip-coletado">7/8 Coletado (entregue ao motoboy)</span>
      <span class="vr mx-2"></span>
      <span class="chip chip-motoboy">üõµ Motoboy</span>
      <span class="chip chip-outros">üöö Outras transportadoras</span>
    </div>
  </div>
</section>

<div class="d-flex justify-content-end align-items-center gap-2 mb-3">
  <span class="text-muted small">Atualiza s√≥ as linhas alteradas</span>
</div>

{% for titulo, pedidos, classe, status in [
    ('üì¨ Pedidos Pendentes', pendentes, 'table-pendentes table-modern', 'badge-pendentes'),
    ('üõ† Pedidos em Separa√ß√£o', separacao, 'table-separacao table-modern', 'badge-separacao'),
    ('üöõ Aguardando Coleta', aguardando, 'table-aguardando table-modern', ''),
    ('üì¶ Coletado', coletado, 'table-coletado table-modern', '')
] %}

  <section class="card shadow-sm mb-4 border-0 section-card">
    <div class="card-header bg-white d-flex flex-wrap align-items-center justify-content-between gap-2 header-slim">
      <div class="d-flex align-items-center gap-2">
        <h2 class="titulo-sessao m-0">{{ titulo }}</h2>
        {% if status %}
          <span class="badge badge-status {{ status }}">Situa√ß√£o {{ loop.index + 4 }}</span>
        {% endif %}
      </div>

      <!-- Contadores: Total ‚Ä¢ Motoboy ‚Ä¢ Outros -->
      <div class="d-flex align-items-center gap-2 subcounts">
        <span class="chip chip-soft counter-total">Total: {{ pedidos|length }}</span>
        <span class="chip chip-motoboy counter-moto">Motoboy: 0</span>
        <span class="chip chip-outros counter-outros">Outros: 0</span>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive table-wrap">
        <table class="table align-middle mb-0 {{ classe }}">
          <thead>
            <tr>
              <th class="col-id">ID</th>
              <th class="col-data">Data/Hora</th>
              <th class="col-codigo">C√≥digo</th>
              <th class="col-cliente">Cliente</th>
              <th class="col-transp">Transportadora</th>
              <th class="col-acoes">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="{% if titulo.startswith('üì¨') %}tbody-pendentes{% elif titulo.startswith('üõ†') %}tbody-separacao{% elif titulo.startswith('üöõ') %}tbody-aguardando{% else %}tbody-coletado{% endif %}">
            {% if pedidos|length == 0 %}
              <tr class="row-empty">
                <td colspan="100%" class="py-4 text-muted text-center">üóÇ Nenhum registro para exibir.</td>
              </tr>
            {% endif %}

            {% for pedido in pedidos %}
            <tr data-codigo="{{ pedido.codigo }}" class="{% if pedido.transportadoraId == 23 %}is-moto{% endif %}">
              <td class="text-muted">{{ pedido.id }}</td>
              <td>
                <span class="font-monospace" data-order="{{ (pedido.dataHora or '') }}"
                      title="{{ (pedido.dataHora or '') }}">
                  {{ (pedido.dataHora or '') }}
                </span>
              </td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <span class="font-monospace fw-semibold">{{ pedido.codigo }}</span>
                  <button onclick="mostrarDetalhes('{{ pedido.codigo }}', this); prepararBipagem('{{ pedido.codigo }}');"
                          class="btn btn-sm btn-outline-secondary rounded-pill px-2 btn-pill"
                          title="Mostrar itens">‚¨áÔ∏è</button>
                </div>
              </td>
              <td class="text-truncate" style="max-width: 420px;">{{ pedido.cliente }}</td>
              <td>
                {% set is_motoboy = (pedido.transportadoraId == 23) %}
                <span class="chip {{ 'chip-motoboy' if is_motoboy else 'chip-outros' }}">
                  {{ 'üõµ' if is_motoboy else 'üöö' }} {{ pedido.transportadora }}
                </span>
              </td>
              <td>
                <div class="d-flex align-items-center flex-wrap gap-2">
                  {% if titulo == 'üì¨ Pedidos Pendentes' and pedido.transportadoraId == 23 %}
                    <form method="GET" action="/etiqueta/{{ pedido.codigo }}" target="_blank" class="d-inline-flex gap-1">
                      <div class="input-group input-group-sm" style="max-width: 260px;">
                        <input type="text" name="codigo_retirada" class="form-control form-control-sm"
                               placeholder="C√≥digo retirada" required>
                        <button type="submit" class="btn btn-outline-secondary btn-sm">üñ®Ô∏è</button>
                      </div>
                    </form>
                  {% endif %}

                  {% if pedido.codigo and pedido.codigo.startswith('0022') %}
                    {% if pedido.contato %}
                      <a href="https://wa.me/{{ pedido.contato }}" target="_blank" class="btn btn-icon btn-wpp"
                         title="WhatsApp">
                        <img src="{{ url_for('static', filename='wpp_icon.png') }}" alt="WhatsApp">
                      </a>
                    {% else %}
                      <button class="btn btn-sm btn-outline-secondary"
                              onclick="refreshContato('{{ pedido.codigo }}', this)" title="Atualizar contato">‚ü≥</button>
                    {% endif %}
                  {% endif %}

                  <button class="btn btn-primary btn-sm btn-bipar"
                          onclick="biparPedido('{{ pedido.codigo }}')"
                          data-bipar-main
                          title="Confirmar bipagem">‚úÖ Bipar</button>

                  {% if not titulo.startswith('üì¶') %}
                  <button class="btn btn-sm btn-outline-danger"
                          onclick="cancelarPedido('{{ pedido.codigo }}')"
                          title="Cancelar pedido">
                    ‚ùå Cancelar
                  </button>
                  {% endif %}


                  <!-- fallback spinner (mantido para compatibilidade) -->
                  <span id="loading-{{ pedido.codigo }}" class="ms-1" style="display:none;">
                    <span class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></span>
                  </span>
                </div>
              </td>
            </tr>

            <tr id="detalhes-{{ pedido.codigo }}" class="bg-light detalhes" style="display:none;">
              <td colspan="100%">
                <div class="p-3 d-flex gap-3 flex-wrap">
                  <div id="bipar-box-{{ pedido.codigo }}" class="card shadow-sm bipar-box">
                    <div class="card-body p-3">
                      <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="badge text-bg-secondary" id="contagem-{{ pedido.codigo }}">‚Äî</span>
                        <span class="small text-muted">itens</span>
                      </div>
                      <button class="btn btn-primary w-100 btn-bipar"
                              onclick="biparPedido('{{ pedido.codigo }}')"
                              data-bipar-detail>‚úÖ Bipar pedido</button>
                    </div>
                  </div>
                  <div id="produtos-{{ pedido.codigo }}" class="d-flex flex-wrap gap-3 flex-grow-1"></div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
{% endfor %}
<section class="card shadow-sm mb-4 border-0 section-card">
  <div class="card-header bg-white d-flex flex-wrap align-items-center justify-content-between gap-2 header-slim">
    <div class="d-flex align-items-center gap-2">
      <h2 class="titulo-sessao m-0">‚ùå Pedidos Cancelados</h2>
    </div>

    <div class="d-flex align-items-center gap-2 subcounts">
      <span class="chip chip-soft counter-total">Total: {{ cancelado|length }}</span>
      <span class="chip chip-motoboy counter-moto">Motoboy: 0</span>
      <span class="chip chip-outros counter-outros">Outros: 0</span>
    </div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive table-wrap">
      <table class="table align-middle mb-0 table-modern">
        <thead>
          <tr>
            <th class="col-id">ID</th>
            <th class="col-data">Data/Hora</th>
            <th class="col-codigo">C√≥digo</th>
            <th class="col-cliente">Cliente</th>
            <th class="col-transp">Transportadora</th>
            <th class="col-acoes">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbody-cancelado">
          {% if cancelado|length == 0 %}
            <tr class="row-empty">
              <td colspan="100%" class="py-4 text-muted text-center">
                üóÇ Nenhum registro para exibir.
              </td>
            </tr>
          {% endif %}

          {% for pedido in cancelado %}
          <tr data-codigo="{{ pedido.codigo }}" class="{% if pedido.transportadoraId == 23 %}is-moto{% endif %}">
            <td class="text-muted">{{ pedido.id }}</td>
            <td>
              <span class="font-monospace" data-order="{{ (pedido.dataHora or '') }}"
                    title="{{ (pedido.dataHora or '') }}">
                {{ (pedido.dataHora or '') }}
              </span>
            </td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <span class="font-monospace fw-semibold">{{ pedido.codigo }}</span>
                <button onclick="mostrarDetalhes('{{ pedido.codigo }}', this); prepararBipagem('{{ pedido.codigo }}');"
                        class="btn btn-sm btn-outline-secondary rounded-pill px-2 btn-pill"
                        title="Mostrar itens">
                  ‚¨áÔ∏è
                </button>
              </div>
            </td>
            <td class="text-truncate" style="max-width: 420px;">{{ pedido.cliente }}</td>
            <td>
              {% set is_motoboy = (pedido.transportadoraId == 23) %}
              <span class="chip {{ 'chip-motoboy' if is_motoboy else 'chip-outros' }}">
                {{ 'üõµ' if is_motoboy else 'üöö' }} {{ pedido.transportadora }}
              </span>
            </td>
            <td>
              <div class="d-flex align-items-center flex-wrap gap-2">
                {% if pedido.codigo and pedido.codigo.startswith('0022') %}
                  {% if pedido.contato %}
                    <a href="https://wa.me/{{ pedido.contato }}" target="_blank" class="btn btn-icon btn-wpp"
                       title="WhatsApp">
                      <img src="{{ url_for('static', filename='wpp_icon.png') }}" alt="WhatsApp">
                    </a>
                  {% else %}
                    <button class="btn btn-sm btn-outline-secondary"
                            onclick="refreshContato('{{ pedido.codigo }}', this)"
                            title="Atualizar contato">
                      ‚ü≥
                    </button>
                  {% endif %}
                {% endif %}
              </div>
            </td>
          </tr>

          <tr id="detalhes-{{ pedido.codigo }}" class="bg-light detalhes" style="display:none;">
            <td colspan="100%">
              <div class="p-3 d-flex gap-3 flex-wrap">
                <div id="bipar-box-{{ pedido.codigo }}" class="card shadow-sm bipar-box">
                  <div class="card-body p-3">
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="badge text-bg-secondary" id="contagem-{{ pedido.codigo }}">‚Äî</span>
                      <span class="small text-muted">itens</span>
                    </div>
                    <input type="text" class="form-control form-control-sm mb-2"
                           placeholder="C√≥digo de barras / SKU"
                           onkeydown="if(event.key==='Enter'){event.preventDefault();biparItem('{{ pedido.codigo }}', this.value);this.value='';}">
                    <div class="small text-muted">Use a bipagem para conferir os itens cancelados, se necess√°rio.</div>
                  </div>
                </div>
                <div id="produtos-{{ pedido.codigo }}" class="d-flex flex-wrap gap-3 flex-grow-1"></div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
<audio id="audio-confirmacao" preload="auto">
  <source src="{{ url_for('static', filename='Confirma√ß√£o_pedidos.mp3') }}" type="audio/mpeg">
</audio>

<style>
/* ===== Tema Moderno (cores base) ===== */
:root{
  --bg: #f6f9fc;
  --text: #1f2937;
  --muted: #6b7280;
  --line: #e6eef5;
  --soft: #eef4fb;

  --pendente: #f4f5ff;
  --separacao: #f2f7ff;
  --aguardando: #fff7e6;
  --coletado: #e9f8ef;

  --chip: #eef1f5;
  --chip-text: #223;
  --chip-border: #dde4ee;

  --moto: #175cd3;   /* azul */
  --outros: #64748b; /* cinza */
}

/* ===== Cart√µes ===== */
.section-card{ border: 1px solid var(--line); border-radius: 14px; overflow: hidden; }
.header-slim{ border-bottom: 2px solid #e5eef7; }
.titulo-sessao{ font-size: 1.25rem; font-weight: 700; color: var(--text); }

/* ===== Chips / Badges ===== */
.chip{
  display:inline-flex; align-items:center; gap:.4rem;
  padding:.25rem .55rem; border:1px solid var(--chip-border);
  border-radius:999px; background:var(--chip); color:var(--chip-text);
  font-weight:600; font-size:.78rem; line-height:1;
}
.chip-soft{ background: #f7f9fc; }
.chip-motoboy{ background:#ebf1ff; border-color:#d7e3ff; color:#153e75; }
.chip-outros{ background:#eef2f7; border-color:#e2e8f0; color:#334155; }
.chip-pendente{ background:#f6f6ff; color:#2d2a8a; }
.chip-separacao{ background:#eef6ff; color:#0b4a6f; }
.chip-aguardando{ background:#fff1da; color:#8a5e00; }
.chip-coletado{ background:#e7fbef; color:#0b6b34; }

.badge-status{ font-weight:700; }

/* ===== Tabelas Modernas ===== */
.table-wrap{ max-height: 70vh; }
.table-modern thead th{
  position: sticky; top: 0; z-index: 2;
  background: #fff; border-bottom: 2px solid var(--line);
  font-size: .83rem; letter-spacing: .02em; text-transform: uppercase;
  color: var(--muted);
}
.table-modern tbody tr{ transition: background-color .18s ease, box-shadow .18s ease; }
.table-modern tbody tr:hover{ background: var(--soft); }
.table-modern tbody tr td{ border-top: 1px solid var(--line); vertical-align: middle; }
.table-modern .col-id{ width: 78px; }
.table-modern .col-data{ width: 130px; }
.table-modern .col-codigo{ width: 220px; }
.table-modern .col-transp{ width: 220px; }
.table-modern .col-acoes{ width: 280px; }

/* faixa de destaque na esquerda para Motoboy */
.table-modern tbody tr.is-moto{ box-shadow: inset 3px 0 0 0 var(--moto); }

/* c√©lulas */
.font-monospace{ font-variant-numeric: tabular-nums; }
.btn-pill{ line-height: 1; }

/* linha em processamento */
.row-loading { opacity:.70; }
.btn-bipar[data-loading="1"]{
  pointer-events: none; opacity:.85;
}
.btn-bipar[data-loading="1"]::before{
  content:''; display:inline-block; width:0.9em; height:0.9em; margin-right:.5em;
  border-radius:50%; border:2px solid rgba(255,255,255,.7);
  border-top-color:rgba(255,255,255,0); animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* bot√£o WhatsApp redondo */
.btn-icon.btn-wpp{
  display:inline-flex; align-items:center; justify-content:center;
  width:32px; height:32px; border-radius:999px; padding:0;
  background:#e8f8ef; border:1px solid #bfe9d2;
}
.btn-icon.btn-wpp img{ width:18px; height:18px; }

/* caixa bipagem */
.bipar-box { min-width:220px; max-width:260px; border:1px solid var(--line); border-radius:12px; }
.detalhes{ background: #fbfdff !important; }
.flash-open { animation: flashRow .8s ease; }
@keyframes flashRow { 0%{background:#fff8e1} 100%{background:transparent} }

/* ajuda de truncar nome cliente */
.text-truncate{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* cores por se√ß√£o (fundo muito sutil) */
.table-pendentes tbody tr:hover{ background: #f7f8ff; }
.table-separacao tbody tr:hover{ background: #f0f7ff; }
.table-aguardando tbody tr:hover{ background: #fff5e8; }
.table-coletado   tbody tr:hover{ background: #eefcf3; }

/* === VISUAL UPGRADE: Temas por Tabela (n√£o altera funcionalidades) === */
:root{
  --pendente-accent:#6366f1; --pendente-accent2:#a78bfa;
  --separacao-accent:#0ea5e9; --separacao-accent2:#22d3ee;
  --aguardando-accent:#f59e0b; --aguardando-accent2:#f97316;
  --coletado-accent:#10b981; --coletado-accent2:#34d399;
  --thead-text:#0f172a;
}

/* Header colorido por se√ß√£o */
.section-card.tema-pendentes .card-header{
  background: linear-gradient(90deg, var(--pendente-accent), var(--pendente-accent2));
  color:#fff !important; border-bottom:0;
}
.section-card.tema-separacao .card-header{
  background: linear-gradient(90deg, var(--separacao-accent), var(--separacao-accent2));
  color:#003; border-bottom:0; color:#05243b !important;
}
.section-card.tema-aguardando .card-header{
  background: linear-gradient(90deg, var(--aguardando-accent), var(--aguardando-accent2));
  color:#3b2605 !important; border-bottom:0;
}
.section-card.tema-coletado .card-header{
  background: linear-gradient(90deg, var(--coletado-accent), var(--coletado-accent2));
  color:#062d1f !important; border-bottom:0;
}
.section-card[class*="tema-"] .titulo-sessao,
.section-card[class*="tema-"] .badge-status,
.section-card[class*="tema-"] .subcounts .chip{ filter: drop-shadow(0 0 0 rgba(0,0,0,0)); }

/* Tabela com faixa e cabe√ßalho tem√°tico */
.table-modern thead th.thematic{
  color: var(--thead-text);
  background: linear-gradient(180deg, #ffffff, #f8fbff);
  border-bottom: 0;
  position: sticky; top: 0; z-index: 3;
  box-shadow: 0 1px 0 var(--line), 0 6px 14px rgba(15,23,42,.04);
}

.table-pendentes thead th.thematic{ 
  background: linear-gradient(180deg, #ffffff, #f4f7ff);
  box-shadow: inset 0 -2px 0 var(--pendente-accent20, rgba(99,102,241,.35));
}
.table-separacao thead th.thematic{ 
  background: linear-gradient(180deg, #ffffff, #eef9ff);
  box-shadow: inset 0 -2px 0 rgba(14,165,233,.35);
}
.table-aguardando thead th.thematic{ 
  background: linear-gradient(180deg, #ffffff, #fff6e9);
  box-shadow: inset 0 -2px 0 rgba(245,158,11,.35);
}
.table-coletado thead th.thematic{ 
  background: linear-gradient(180deg, #ffffff, #ecfff6);
  box-shadow: inset 0 -2px 0 rgba(16,185,129,.35);
}

/* Borda de realce na lateral esquerda de cada linha */
.table-pendentes tbody tr{ box-shadow: inset 3px 0 0 0 rgba(99,102,241,.35); }
.table-separacao tbody tr{ box-shadow: inset 3px 0 0 0 rgba(14,165,233,.35); }
.table-aguardando tbody tr{ box-shadow: inset 3px 0 0 0 rgba(245,158,11,.35); }
.table-coletado tbody tr  { box-shadow: inset 3px 0 0 0 rgba(16,185,129,.35); }

/* Hover com movimento sutil */
.table-modern tbody tr:hover{
  transform: translateY(-1px);
  box-shadow: 0 2px 10px rgba(2,6,23,.06), inset 3px 0 0 currentColor;
}

/* Bot√µes seguem a paleta da se√ß√£o */
.section-card.tema-pendentes .btn-bipar{ background: linear-gradient(90deg,#6366f1,#a78bfa); border:0; color:#fff; }
.section-card.tema-separacao .btn-bipar{ background: linear-gradient(90deg,#0ea5e9,#22d3ee); border:0; color:#003; }
.section-card.tema-aguardando .btn-bipar{ background: linear-gradient(90deg,#f59e0b,#f97316); border:0; color:#3b2605; }
.section-card.tema-coletado .btn-bipar{ background: linear-gradient(90deg,#10b981,#34d399); border:0; color:#062d1f; }
.section-card .btn-bipar:hover{ filter: brightness(0.95); }

/* Chips de contagem ganham borda colorida */
.section-card.tema-pendentes .chip-soft{ border-color:#a78bfa; }
.section-card.tema-separacao .chip-soft{ border-color:#22d3ee; }
.section-card.tema-aguardando .chip-soft{ border-color:#f97316; }
.section-card.tema-coletado .chip-soft{ border-color:#34d399; }

/* Cantoneira decorativa no card */
.section-card[class*="tema-"]{ position: relative; }
.section-card.tema-pendentes::after,
.section-card.tema-separacao::after,
.section-card.tema-aguardando::after,
.section-card.tema-coletado::after{
  content:""; position:absolute; inset:auto 12px -6px auto; width:72px; height:6px;
  border-radius:999px; filter: blur(10px); opacity:.55;
}
.section-card.tema-pendentes::after{ background: linear-gradient(90deg,#6366f1,#a78bfa); }
.section-card.tema-separacao::after{ background: linear-gradient(90deg,#0ea5e9,#22d3ee); }
.section-card.tema-aguardando::after{ background: linear-gradient(90deg,#f59e0b,#f97316); }
.section-card.tema-coletado::after{ background: linear-gradient(90deg,#10b981,#34d399); }

</style>

<script>
/* ========= Data/Hora: formata√ß√£o + ordena√ß√£o por coluna ========= */
async function cancelarPedido(codigo){
  // 1) senha
  const senha = prompt(`Para cancelar o pedido ${codigo}, digite a senha de supervisor:`);
  if (senha === null) return;
  if (senha !== '4146649'){
    alert('Senha incorreta.');
    return;
  }

  // 2) motivo obrigat√≥rio
  const motivo = prompt(`Informe o motivo do cancelamento do pedido ${codigo}:`);
  if (!motivo || !motivo.trim()){
    alert('O motivo do cancelamento √© obrigat√≥rio.');
    return;
  }

  try{
    setRowLoading(codigo, true);

    const body = new URLSearchParams({
      codigo_pedido: codigo,
      motivo: motivo.trim()
    });

    const resp = await fetch('/cancelar_pedido?ajax=1', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body
    });

    const data = await resp.json().catch(()=>({}));

    if (!resp.ok || !data?.ok){
      setRowLoading(codigo, false);
      throw new Error(data?.erro || `Falha HTTP ${resp.status}`);
    }

    // move linha para tabela de cancelados (situa√ß√£o 26)
    moveLinhaParaTabela(codigo, 'cancelado');

    const msg = (data.flashes && data.flashes[0]) || `Pedido ${codigo} cancelado.`;
    const div = document.createElement('div');
    div.className = 'alert alert-warning position-fixed top-0 start-50 translate-middle-x mt-3 shadow';
    div.style.zIndex = 1080;
    div.textContent = msg;
    document.body.appendChild(div);
    setTimeout(()=>div.remove(), 2500);

  }catch(e){
    alert(e.message || e);
    setRowLoading(codigo, false);
  }
}

  function fmtDataHora(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  if (isNaN(d)) return iso;
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  const base = `${dd}/${mm} ${hh}:${mi}`;
  const d0 = new Date(d); d0.setHours(0,0,0,0);
  const diff = (hoje - d0) / 86400000;
  if (diff === 0) return `Hoje ${hh}:${mi}`;
  if (diff === -86400000/86400000) return `Amanh√£ ${hh}:${mi}`; // seguran√ßa
  if (diff === 1) return `Ontem ${hh}:${mi}`;
  return base;
}
function hydrateDateCells(table) {
  table.querySelectorAll('span[data-order]').forEach(span => {
    const iso = span.getAttribute('data-order') || '';
    span.textContent = fmtDataHora(iso);
    span.title = iso || '';
  });
}
function enableSimpleSort(table) {
  const ths = table.querySelectorAll('thead th');
  ths.forEach((th, idx) => {
    th.style.cursor = 'pointer';
    th.title = 'Ordenar';
    th.addEventListener('click', () => {
      const dir = th.getAttribute('data-sort') === 'asc' ? 'desc' : 'asc';
      ths.forEach(x => x.removeAttribute('data-sort'));
      th.setAttribute('data-sort', dir);

      const tbody = table.querySelector('tbody');
      const mainRows = Array.from(tbody.querySelectorAll('tr[data-codigo]'));

      mainRows.sort((a, b) => {
        const va = cellValue(a, idx);
        const vb = cellValue(b, idx);
        if (!isNaN(va) && !isNaN(vb)) {
          return dir === 'asc' ? (va - vb) : (vb - va);
        }
        return dir === 'asc'
          ? String(va).localeCompare(String(vb), 'pt-BR', {numeric:true, sensitivity:'base'})
          : String(vb).localeCompare(String(va), 'pt-BR', {numeric:true, sensitivity:'base'});
      });

      mainRows.forEach(r => {
        const codigo = r.getAttribute('data-codigo');
        const det = document.getElementById('detalhes-' + codigo);
        tbody.appendChild(r);
        if (det) tbody.appendChild(det);
      });
    });
  });

  function cellValue(row, idx) {
    const cell = row.children[idx];
    if (!cell) return '';
    const ord = cell.querySelector('[data-order]')?.getAttribute('data-order');
    if (ord && !isNaN(Date.parse(ord))) return Date.parse(ord);
    const raw = (cell.textContent || '').trim();
    const num = Number(raw.replace(/\D+/g, ''));
    return raw && !Number.isNaN(num) && /\d/.test(raw) ? num : raw;
  }
}
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('table.table').forEach(t => {
    hydrateDateCells(t);
    enableSimpleSort(t);
  });
});

/* ================== COOLDOWN por pedido (1 minuto) ================== */
const COOLDOWN_MS = 60000;
const bipCooldown = {};
function cdKey(codigo){ return `peg:bip:cd:${codigo}`; }
function cdGet(codigo){
  const m = bipCooldown[codigo] || 0;
  const p = parseInt(localStorage.getItem(cdKey(codigo))||'0',10) || 0;
  return Math.max(m, p);
}
function cdLeft(codigo){ return Math.max(0, COOLDOWN_MS - (Date.now() - cdGet(codigo))); }
function cdSet(codigo){
  const now = Date.now();
  bipCooldown[codigo] = now;
  try{ localStorage.setItem(cdKey(codigo), String(now)); }catch(e){}
}

/* ---------------- helpers de categoria/DOM ---------------- */
const TBODY_MAP = {
  pendentes:  'tbody-pendentes',
  separacao:  'tbody-separacao',
  aguardando: 'tbody-aguardando',
  coletado:   'tbody-coletado',
  cancelado:  'tbody-cancelado'
};
function destinoPorSituacao(sit){
  if (sit === 6)  return 'separacao';
  if (sit === 36) return 'aguardando';
  if (sit === 7 || sit === 8) return 'coletado';
  if (sit === 26) return 'cancelado';
  return null;
}

function tbodyEl(cat){ return document.getElementById(TBODY_MAP[cat]); }

/* Contadores: atualiza Total / Motoboy / Outros por card */
function updateCounters(){
  document.querySelectorAll('.section-card').forEach(card=>{
    const tbody = card.querySelector('tbody');
    const mainRows = tbody ? tbody.querySelectorAll('tr[data-codigo]') : [];
    const total = mainRows.length;
    let moto = 0;
    mainRows.forEach(r => { if (r.classList.contains('is-moto')) moto++; });
    const outros = Math.max(0, total - moto);

    card.querySelector('.counter-total')?.classList.add('chip-soft');
    if (card.querySelector('.counter-total')) card.querySelector('.counter-total').textContent = `Total: ${total}`;
    if (card.querySelector('.counter-moto'))  card.querySelector('.counter-moto').textContent  = `Motoboy: ${moto}`;
    if (card.querySelector('.counter-outros'))card.querySelector('.counter-outros').textContent= `Outros: ${outros}`;

    const empty = tbody?.querySelector('.row-empty');
    if(total>0 && empty) empty.remove();
    if(total===0 && !empty){
      const tr = document.createElement('tr');
      tr.className='row-empty';
      tr.innerHTML = `<td colspan="100%" class="py-4 text-muted text-center">üóÇ Nenhum registro para exibir.</td>`;
      tbody?.appendChild(tr);
    }
  });
}

/* ---------------- UI: LOADING POR PEDIDO ---------------- */
function setRowLoading(codigo, on){
  const spot = document.getElementById('loading-'+codigo);
  const row  = document.querySelector(`tr[data-codigo="${codigo}"]`);
  const mainBtn = row?.querySelector('button[data-bipar-main]');
  const detBtn  = document.querySelector(`#detalhes-${codigo} button[data-bipar-detail]`);
  if (spot) spot.style.display = on ? 'inline-flex' : 'none';
  [mainBtn, detBtn].forEach(btn => { if (btn){ btn.disabled = on; btn.setAttribute('data-loading', on ? '1':'0'); }});
  if (row) row.classList.toggle('row-loading', on);
}

/* ---------------- constru√ß√£o e patch de linhas ---------------- */
function rowHtml(p, categoria){
  const isMoto = Number(p.transportadoraId)===23;
  const wppBtn = (p.codigo && p.codigo.startsWith('0022'))
    ? (p.contato
        ? `<a href="https://wa.me/${p.contato}" target="_blank" class="btn btn-icon btn-wpp" title="WhatsApp">
             <img src="/static/wpp_icon.png" alt="WhatsApp">
           </a>`
        : `<button class="btn btn-sm btn-outline-secondary" onclick="refreshContato('${p.codigo}', this)" title="Atualizar contato">‚ü≥</button>`)
    : '';
  const etiqueta = (categoria==='pendentes' && isMoto)
    ? `<form method="GET" action="/etiqueta/${p.codigo}" target="_blank" class="d-inline-flex gap-1">
         <div class="input-group input-group-sm" style="max-width: 260px;">
           <input type="text" name="codigo_retirada" class="form-control form-control-sm" placeholder="C√≥digo retirada" required>
           <button type="submit" class="btn btn-outline-secondary btn-sm">üñ®Ô∏è</button>
         </div>
       </form>`
    : '';
  const biparBtn = (categoria!=='coletado')
    ? `<button class="btn btn-primary btn-sm btn-bipar" onclick="biparPedido('${p.codigo}')" data-bipar-main title="Confirmar bipagem">‚úÖ Bipar</button>` : '';

  return `
  <tr data-codigo="${p.codigo}" class="${isMoto ? 'is-moto' : ''}">
    <td class="text-muted">${p.id ?? ''}</td>
    <td><span class="font-monospace" data-order="${p.dataHora || ''}" title="${p.dataHora || ''}">${fmtDataHora(p.dataHora || '')}</span></td>
    <td>
      <div class="d-flex align-items-center gap-2">
        <span class="font-monospace fw-semibold">${p.codigo ?? ''}</span>
        <button onclick="mostrarDetalhes('${p.codigo}', this); prepararBipagem('${p.codigo}');"
                class="btn btn-sm btn-outline-secondary rounded-pill px-2 btn-pill" title="Mostrar itens">‚¨áÔ∏è</button>
      </div>
    </td>
    <td class="text-truncate" style="max-width: 420px;">${p.cliente ?? ''}</td>
    <td><span class="chip ${isMoto ? 'chip-motoboy':'chip-outros'}">${isMoto ? 'üõµ' : 'üöö'} ${p.transportadora ?? ''}</span></td>
    <td>
      <div class="d-flex align-items-center flex-wrap gap-2">
        ${etiqueta}
        ${wppBtn}
        ${biparBtn}
        <span id="loading-${p.codigo}" class="ms-1" style="display:none;">
          <span class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></span>
        </span>
      </div>
    </td>
  </tr>
  <tr id="detalhes-${p.codigo}" class="bg-light detalhes" style="display:none;">
    <td colspan="100%">
      <div class="p-3 d-flex gap-3 flex-wrap">
        <div id="bipar-box-${p.codigo}" class="card shadow-sm bipar-box">
          <div class="card-body p-3">
            <div class="d-flex align-items-center gap-2 mb-2">
              <span class="badge text-bg-secondary" id="contagem-${p.codigo}">‚Äî</span>
              <span class="small text-muted">itens</span>
            </div>
            ${categoria!=='coletado' ? `<button class="btn btn-primary w-100 btn-bipar" onclick="biparPedido('${p.codigo}')" data-bipar-detail>‚úÖ Bipar pedido</button>` : ''}
          </div>
        </div>
        <div id="produtos-${p.codigo}" class="d-flex flex-wrap gap-3 flex-grow-1"></div>
      </div>
    </td>
  </tr>`;
}

function insertRow(p, categoria){
  const tb = tbodyEl(categoria); if(!tb) return;
  const wrapper = document.createElement('tbody');
  wrapper.innerHTML = rowHtml(p, categoria).trim();
  const rows = Array.from(wrapper.children);
  rows.forEach((r, i)=>{
    if(i===0) tb.prepend(r);
    else tb.insertBefore(r, tb.querySelector(`tr[data-codigo="${p.codigo}"]`)?.nextSibling || tb.firstChild);
  });
  updateCounters();
}
function removeRow(codigo){
  const row = document.querySelector(`tr[data-codigo="${codigo}"]`);
  const det = document.getElementById(`detalhes-${codigo}`);
  if(det) det.remove();
  if(row) row.remove();
  updateCounters();
}
function updateRow(p){
  const row = document.querySelector(`tr[data-codigo="${p.codigo}"]`);
  if(!row) return insertRow(p, 'separacao');
  row.children[0].textContent = p.id ?? '';
  const dhSpan = row.children[1].querySelector('span[data-order]');
  if (dhSpan) { dhSpan.setAttribute('data-order', p.dataHora || ''); dhSpan.textContent = fmtDataHora(p.dataHora || ''); dhSpan.title = p.dataHora || ''; }
  row.querySelector('.font-monospace').textContent = p.codigo ?? '';
  row.children[3].textContent = p.cliente ?? '';
  const chipCell = row.children[4].querySelector('.chip');
  if(chipCell){
    const isMoto = Number(p.transportadoraId)===23;
    chipCell.className = 'chip ' + (isMoto ? 'chip-motoboy' : 'chip-outros');
    chipCell.textContent = (isMoto ? 'üõµ ' : 'üöö ') + (p.transportadora ?? '');
    row.classList.toggle('is-moto', isMoto);
  }
  updateCounters();
}

/* ---------------- refresh por DIF ---------------- */
async function refreshSnapshot(){
  const btns = document.querySelectorAll('button[onclick="refreshSnapshot()"]');
  btns.forEach(b=>b.disabled=true);
  try{
    const resp = await fetch('/api/refresh_snapshot',{method:'POST'});
    const data = await resp.json();
    if(!resp.ok || !data?.ok) throw new Error(data?.error||'Falha ao atualizar');

    const patch = data.patch || {};
    for(const cat of ['pendentes','separacao','aguardando','coletado']){
      const pcat = patch[cat] || {};
      (pcat.removed||[]).forEach(p => removeRow(p.codigo));
      (pcat.updated||[]).forEach(u => updateRow(u.after));
      (pcat.added||[]).forEach(p => insertRow(p, cat));
    }

    const div=document.createElement('div');
    div.className='alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3 shadow';
    div.style.zIndex=1080;
    div.textContent='Snapshot aplicado: tabelas atualizadas por diferen√ßa.';
    document.body.appendChild(div); setTimeout(()=>div.remove(),1800);

  }catch(e){
    alert('Erro na atualiza√ß√£o por dif: '+(e.message||e));
  }finally{
    btns.forEach(b=>b.disabled=false);
  }
}

/* ---------------- bipagem com LOADING + COOLDOWN ---------------- */
function moveLinhaParaTabela(codigo, destino){
  const row=document.querySelector(`tr[data-codigo="${codigo}"]`);
  const det=document.getElementById(`detalhes-${codigo}`);
  const tbody=document.getElementById(`tbody-${destino}`);
  if(!row||!tbody) return;
  row.style.transition='opacity .2s'; row.style.opacity='0.6';
  if(det){det.style.transition='opacity .2s'; det.style.opacity='0.6';}
  setTimeout(()=>{
    tbody.prepend(row);
    if(det) tbody.insertBefore(det,row.nextSibling);

    if(destino==='coletado'){
      const actions = row.querySelector('td:last-child .d-flex');
      if(actions){
        actions.querySelectorAll('button').forEach(btn=>{
          if((btn.textContent||'').includes('Bipar') || (btn.getAttribute('onclick')||'').includes('biparPedido')) btn.remove();
        });
      }
      const inner = det?.querySelector('button[onclick^="biparPedido("]'); if(inner) inner.remove();
    }

    setRowLoading(codigo, false);
    requestAnimationFrame(()=>{row.style.opacity='1'; if(det)det.style.opacity='1'; updateCounters();});
  },180);
}

async function prepararBipagem(codigo){
  try{
    const cont=document.getElementById('contagem-'+codigo);
    const r=await fetch(`/detalhes/${codigo}`);
    const j=await r.json().catch(()=>({}));
    const itens=Array.isArray(j?.itens)?j.itens:[];
    const total=itens.reduce((s,i)=>s+(parseInt(i.quantidade,10)||0),0);
    if(cont) cont.textContent=total||'0';
    const row=document.getElementById('detalhes-'+codigo);
    if(row){row.classList.add('flash-open'); setTimeout(()=>row.classList.remove('flash-open'),800);}
  }catch(e){console.error(e);}
}

async function biparPedido(codigo){
  try{
    const left = cdLeft(codigo);
    if(left>0){
      const secs = Math.ceil(left/1000);
      alert(`Aguarde ${secs}s para bipar novamente o pedido ${codigo}.`);
      return;
    }

    const r=await fetch(`/detalhes/${codigo}`);
    const j=await r.json().catch(()=>({}));
    const itens=Array.isArray(j?.itens)?j.itens:[]; 
    const total=itens.reduce((s,i)=>s+(parseInt(i.quantidade,10)||0),0);

    if(!confirm(`Bipar o pedido ${codigo}?`)) return;

    // Inicia LOADING visual
    setRowLoading(codigo, true);

    const audio=(total>=2)?document.getElementById('audio-confirmacao'):document.getElementById('notif-audio');
    if(audio){audio.currentTime=0; await audio.play().catch(()=>{});}

    const body=new URLSearchParams({codigo_pedido:codigo});
    const resp=await fetch('/confirmar?ajax=1',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded','X-Requested-With':'XMLHttpRequest'},body});
    const data=await resp.json().catch(()=>({}));

    if(resp.status===429){
      setRowLoading(codigo, false);
      const secs = data?.cooldown ?? 60;
      alert(data?.erro || `Aguarde ${secs}s para bipar novamente.`);
      return;
    }
    if(!resp.ok||!data?.ok){
      setRowLoading(codigo, false);
      throw new Error(data?.erro||`Falha HTTP ${resp.status}`);
    }

    cdSet(codigo);

    const destino=destinoPorSituacao(data.nova_situacao);
    if(destino){
      moveLinhaParaTabela(codigo,destino);
    }else{
      setRowLoading(codigo, false);
    }

    const msg=(data.flashes&&data.flashes[0])?data.flashes[0]:`Pedido ${codigo} atualizado.`;
    const div=document.createElement('div');
    div.className='alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3 shadow';
    div.style.zIndex=1080; div.textContent=msg;
    document.body.appendChild(div); setTimeout(()=>div.remove(),2000);
  }catch(e){
    setRowLoading(codigo, false);
    alert('Erro ao bipar: '+(e.message||e));
  }
}

/* ---------------- refresh de contato ---------------- */
async function refreshContato(codigo, btn){
  if(btn) btn.disabled = true;
  try{
    const r = await fetch(`/api/refresh_contato/${codigo}`, {method: 'POST'});
    const j = await r.json();
    if(j.ok){
      const row=document.querySelector(`tr[data-codigo="${codigo}"]`);
      if(row){
        const wrap=row.querySelector('td:last-child .d-flex');
        const exist = row.querySelector('.btn-wpp');
        if(!exist){
          wrap.insertAdjacentHTML('beforeend', `<a href="${j.wa}" target="_blank" class="btn btn-icon btn-wpp" title="WhatsApp"><img src="/static/wpp_icon.png" alt="WhatsApp"></a>`);
        }else{
          exist.href = j.wa;
        }
      }
    }else{
      alert(j.erro || 'Sem contato v√°lido');
    }
  }catch(e){ alert('Falha ao atualizar contato'); }
  finally{ if(btn) btn.disabled=false; }
}

/* Inicializa contadores ao carregar */
document.addEventListener('DOMContentLoaded', updateCounters);
</script>


<!-- VISUAL UPGRADE: Aplica classes tem√°ticas automaticamente sem alterar fun√ß√µes -->
<script>
(function(){
  function classifySection(section){
    const titleEl = section.querySelector('.titulo-sessao');
    if(!titleEl) return;
    const t = (titleEl.textContent || "").toLowerCase();
    let tema = "";
    if (t.includes("üì¨") || t.includes("pendente")) tema = "tema-pendentes";
    else if (t.includes("üß©") || t.includes("separa√ß√£o") || t.includes("separacao")) tema = "tema-separacao";
    else if (t.includes("üöõ") || t.includes("aguardando")) tema = "tema-aguardando";
    else if (t.includes("‚úÖ") || t.includes("coletado")) tema = "tema-coletado";
    if(tema){
      section.classList.add(tema);
      // marca cabe√ßalho da tabela para receber estilo "thematic"
      const ths = section.querySelectorAll('table thead th');
      ths.forEach(th => th.classList.add('thematic'));
      // se a tabela n√£o tiver classe espec√≠fica, tenta inferir pelo tema
      const table = section.querySelector('table');
      if(table){
        if(tema.endsWith('pendentes')) table.classList.add('table-pendentes');
        if(tema.endsWith('separacao')) table.classList.add('table-separacao');
        if(tema.endsWith('aguardando')) table.classList.add('table-aguardando');
        if(tema.endsWith('coletado')) table.classList.add('table-coletado');
      }
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.section-card').forEach(classifySection);
  });
})();
</script>
